#!/usr/bin/env bash
#
# unit-list: List all worktrees and their occupancy status.
#
# Usage: unit-list
#   - Shows all worktrees in current repo
#   - Indicates which are occupied by tmux panes

set -e

DOTF_AGENTS_WORKTREE_DIR="${DOTF_AGENTS_WORKTREE_DIR:-.agents}"

# Get repo context.
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
if [[ -z "$REPO_ROOT" ]]; then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

REPO_NAME=$(basename "$REPO_ROOT" | tr '[:upper:]' '[:lower:]' | tr -cs '[:alnum:]-' '-' | sed 's/^-//;s/-$//')
WORKTREE_BASE="$REPO_ROOT/$DOTF_AGENTS_WORKTREE_DIR"

# Get list of worktrees.
echo "Worktrees for $REPO_NAME:"
echo ""

if [[ ! -d "$WORKTREE_BASE" ]]; then
    echo "  No worktrees found ($DOTF_AGENTS_WORKTREE_DIR directory does not exist)"
    echo ""
    echo "Use 'unit-new <ticket>' to create a new worktree"
    exit 0
fi

# Get tmux pane paths for occupancy check.
OCCUPIED_PATHS=""
if [[ -n "$TMUX" ]]; then
    OCCUPIED_PATHS=$(tmux list-panes -a -F '#{pane_current_path}' 2>/dev/null || true)
fi

# List worktrees with status.
printf "  %-25s %-30s %s\n" "TICKET" "BRANCH" "STATUS"
printf "  %-25s %-30s %s\n" "------" "------" "------"

git worktree list --porcelain | while read -r line; do
    case "$line" in
        worktree\ *)
            WORKTREE_PATH="${line#worktree }"
            ;;
        branch\ *)
            BRANCH="${line#branch refs/heads/}"
            # Only show worktrees in agents directory.
            if [[ "$WORKTREE_PATH" == "$WORKTREE_BASE"/* ]]; then
                TICKET=$(basename "$WORKTREE_PATH")

                # Check if occupied.
                STATUS="idle"
                if [[ -n "$OCCUPIED_PATHS" ]] && echo "$OCCUPIED_PATHS" | grep -q "^$WORKTREE_PATH$"; then
                    STATUS="occupied"
                fi

                printf "  %-25s %-30s %s\n" "$TICKET" "$BRANCH" "$STATUS"
            fi
            WORKTREE_PATH=""
            BRANCH=""
            ;;
    esac
done

echo ""
